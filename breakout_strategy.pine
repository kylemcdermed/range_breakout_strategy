//@version=5
strategy("NY AM Range Breakout (7-9am)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100, pyramiding=0, commission_type=strategy.commission.cash_per_contract, commission_value=5.0, slippage=2)

var float ny_high = na
var float ny_low = na
var float range_size = na
var bool partial_closed = false

current_hour = hour(time, "America/New_York")
is_ny_session = (current_hour >= 7 and current_hour < 9)

// Reset daily
if ta.change(dayofmonth)
    ny_high := na
    ny_low := na
    range_size := na
    partial_closed := false
    strategy.cancel_all()

// Record high/low during 7-10am and set range size
if is_ny_session
    ny_high := na(ny_high) ? high : math.max(ny_high, high)
    ny_low := na(ny_low) ? low : math.min(ny_low, low)
    if not na(ny_high) and not na(ny_low)
        range_size := ny_high - ny_low

// Cancel all orders after NY session ends
if not is_ny_session and current_hour >= 10
    strategy.cancel_all()

// Place breakout entries only during NY session
if is_ny_session and not na(ny_high) and not na(ny_low)
    strategy.entry("Long", strategy.long, qty=2, stop=ny_high)
    strategy.entry("Short", strategy.short, qty=2, stop=ny_low)

// Long trade management
if strategy.position_size > 0
    entry_price = strategy.position_avg_price
    stop_loss = ny_low
    take_profit = entry_price + range_size
    partial_target = entry_price + (range_size * 0.5)
    
    if not partial_closed
        strategy.exit("Long Exit", "Long", stop=stop_loss, limit=take_profit, qty=2)
        
        if high >= partial_target
            strategy.close("Long", qty=1, comment="Partial TP")
            strategy.exit("Long Trail", "Long", stop=entry_price + 5, limit=take_profit, qty=1)
            partial_closed := true

// Short trade management  
if strategy.position_size < 0
    entry_price = strategy.position_avg_price
    stop_loss = ny_high
    take_profit = entry_price - range_size
    partial_target = entry_price - (range_size * 0.5)
    
    if not partial_closed
        strategy.exit("Short Exit", "Short", stop=stop_loss, limit=take_profit, qty=2)
        
        if low <= partial_target
            strategy.close("Short", qty=1, comment="Partial TP")
            strategy.exit("Short Trail", "Short", stop=entry_price - 5, limit=take_profit, qty=1)
            partial_closed := true

// Reset partial closed flag when no position
if strategy.position_size == 0
    partial_closed := false
