//@version=5
strategy("NY AM + PM Session Range Breakout", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100, pyramiding=0, commission_type=strategy.commission.cash_per_contract, commission_value=2.5, slippage=1)

// NY AM Session Variables
var float ny_am_high = na
var float ny_am_low = na
var float ny_am_range_size = na
var bool ny_am_partial_closed = false

// NY PM Session Variables
var float ny_pm_high = na
var float ny_pm_low = na
var float ny_pm_range_size = na
var bool ny_pm_partial_closed = false

current_hour = hour(time, "America/New_York")
is_ny_am_session = (current_hour >= 7 and current_hour < 10)
is_ny_pm_session = (current_hour >= 13 and current_hour < 16)

// Reset daily
if ta.change(dayofmonth)
    // Reset NY AM variables
    ny_am_high := na
    ny_am_low := na
    ny_am_range_size := na
    ny_am_partial_closed := false
    
    // Reset NY PM variables
    ny_pm_high := na
    ny_pm_low := na
    ny_pm_range_size := na
    ny_pm_partial_closed := false
    
    strategy.cancel_all()

// ===== NY AM SESSION (7-10am) =====
// Record NY AM high/low during 7-10am and set range size
if is_ny_am_session
    ny_am_high := na(ny_am_high) ? high : math.max(ny_am_high, high)
    ny_am_low := na(ny_am_low) ? low : math.min(ny_am_low, low)
    if not na(ny_am_high) and not na(ny_am_low)
        ny_am_range_size := ny_am_high - ny_am_low

// Cancel NY AM orders after session ends
if not is_ny_am_session and current_hour >= 10 and current_hour < 13
    strategy.cancel("NY_AM_Long")
    strategy.cancel("NY_AM_Short")

// Place NY AM breakout entries during session
if is_ny_am_session and not na(ny_am_high) and not na(ny_am_low)
    strategy.entry("NY_AM_Long", strategy.long, qty=1, stop=ny_am_high)
    strategy.entry("NY_AM_Short", strategy.short, qty=1, stop=ny_am_low)

// ===== NY PM SESSION (1:30-4pm) =====
// Record NY PM high/low during 1:30-4pm and set range size
if is_ny_pm_session
    ny_pm_high := na(ny_pm_high) ? high : math.max(ny_pm_high, high)
    ny_pm_low := na(ny_pm_low) ? low : math.min(ny_pm_low, low)
    if not na(ny_pm_high) and not na(ny_pm_low)
        ny_pm_range_size := ny_pm_high - ny_pm_low

// Cancel NY PM orders after session ends
if not is_ny_pm_session and current_hour >= 16
    strategy.cancel("NY_PM_Long")
    strategy.cancel("NY_PM_Short")

// Place NY PM breakout entries during session
if is_ny_pm_session and not na(ny_pm_high) and not na(ny_pm_low)
    strategy.entry("NY_PM_Long", strategy.long, qty=1, stop=ny_pm_high)
    strategy.entry("NY_PM_Short", strategy.short, qty=1, stop=ny_pm_low)

// ===== NY AM TRADE MANAGEMENT =====
// NY AM Long trade management
if strategy.position_size > 0 and str.contains(strategy.opentrades.entry_id(strategy.opentrades - 1), "NY_AM_Long")
    entry_price = strategy.position_avg_price
    stop_loss = ny_am_low
    take_profit = entry_price + ny_am_range_size
    partial_target = entry_price + (ny_am_range_size * 0.5)
    
    if not ny_am_partial_closed
        strategy.exit("NY_AM_Long_Exit", "NY_AM_Long", stop=stop_loss, limit=take_profit, qty=1)
        
        if high >= partial_target
            strategy.close("NY_AM_Long", qty=0.5, comment="NY AM Partial TP")
            strategy.exit("NY_AM_Long_Trail", "NY_AM_Long", stop=entry_price + 5, limit=take_profit, qty=0.5)
            ny_am_partial_closed := true

// NY AM Short trade management  
if strategy.position_size < 0 and str.contains(strategy.opentrades.entry_id(strategy.opentrades - 1), "NY_AM_Short")
    entry_price = strategy.position_avg_price
    stop_loss = ny_am_high
    take_profit = entry_price - ny_am_range_size
    partial_target = entry_price - (ny_am_range_size * 0.5)
    
    if not ny_am_partial_closed
        strategy.exit("NY_AM_Short_Exit", "NY_AM_Short", stop=stop_loss, limit=take_profit, qty=1)
        
        if low <= partial_target
            strategy.close("NY_AM_Short", qty=0.5, comment="NY AM Partial TP")
            strategy.exit("NY_AM_Short_Trail", "NY_AM_Short", stop=entry_price - 5, limit=take_profit, qty=0.5)
            ny_am_partial_closed := true

// ===== NY PM TRADE MANAGEMENT =====
// NY PM Long trade management
if strategy.position_size > 0 and str.contains(strategy.opentrades.entry_id(strategy.opentrades - 1), "NY_PM_Long")
    entry_price = strategy.position_avg_price
    stop_loss = ny_pm_low
    take_profit = entry_price + ny_pm_range_size
    partial_target = entry_price + (ny_pm_range_size * 0.5)
    
    if not ny_pm_partial_closed
        strategy.exit("NY_PM_Long_Exit", "NY_PM_Long", stop=stop_loss, limit=take_profit, qty=1)
        
        if high >= partial_target
            strategy.close("NY_PM_Long", qty=0.5, comment="NY PM Partial TP")
            strategy.exit("NY_PM_Long_Trail", "NY_PM_Long", stop=entry_price + 5, limit=take_profit, qty=0.5)
            ny_pm_partial_closed := true

// NY PM Short trade management  
if strategy.position_size < 0 and str.contains(strategy.opentrades.entry_id(strategy.opentrades - 1), "NY_PM_Short")
    entry_price = strategy.position_avg_price
    stop_loss = ny_pm_high
    take_profit = entry_price - ny_pm_range_size
    partial_target = entry_price - (ny_pm_range_size * 0.5)
    
    if not ny_pm_partial_closed
        strategy.exit("NY_PM_Short_Exit", "NY_PM_Short", stop=stop_loss, limit=take_profit, qty=1)
        
        if low <= partial_target
            strategy.close("NY_PM_Short", qty=0.5, comment="NY PM Partial TP")
            strategy.exit("NY_PM_Short_Trail", "NY_PM_Short", stop=entry_price - 5, limit=take_profit, qty=0.5)
            ny_pm_partial_closed := true

// Reset partial closed flags when no position
if strategy.position_size == 0
    ny_am_partial_closed := false
    ny_pm_partial_closed := false
