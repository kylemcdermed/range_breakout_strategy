//@version=5
strategy("NY PM Session Range Breakout", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100, pyramiding=0, commission_type=strategy.commission.cash_per_contract, commission_value=5.0, slippage=2)

var float ny_pm_high = na
var float ny_pm_low = na
var float ny_pm_range_size = na
var bool ny_pm_partial_closed = false

current_hour = hour(time, "America/New_York")
is_ny_pm_session = (current_hour >= 13 and current_hour < 16)

// Reset daily
if ta.change(dayofmonth)
    ny_pm_high := na
    ny_pm_low := na
    ny_pm_range_size := na
    ny_pm_partial_closed := false
    strategy.cancel_all()

// ===== NY PM SESSION (1-4pm) =====
// Record NY PM high/low during 1-4pm and set range size
if is_ny_pm_session
    ny_pm_high := na(ny_pm_high) ? high : math.max(ny_pm_high, high)
    ny_pm_low := na(ny_pm_low) ? low : math.min(ny_pm_low, low)
    if not na(ny_pm_high) and not na(ny_pm_low)
        ny_pm_range_size := ny_pm_high - ny_pm_low

// Cancel NY PM orders after session ends
if not is_ny_pm_session and current_hour >= 16
    strategy.cancel("NY_PM_Long")
    strategy.cancel("NY_PM_Short")

// Place NY PM breakout entries during session
if is_ny_pm_session and not na(ny_pm_high) and not na(ny_pm_low)
    strategy.entry("NY_PM_Long", strategy.long, qty=2, stop=ny_pm_high)
    strategy.entry("NY_PM_Short", strategy.short, qty=2, stop=ny_pm_low)

// ===== NY PM TRADE MANAGEMENT =====
// NY PM Long trade management
if strategy.position_size > 0
    entry_price = strategy.position_avg_price
    stop_loss = ny_pm_low
    take_profit = entry_price + ny_pm_range_size
    partial_target = entry_price + (ny_pm_range_size * 0.5)
    
    if not ny_pm_partial_closed
        strategy.exit("NY_PM_Long_Exit", "NY_PM_Long", stop=stop_loss, limit=take_profit, qty=2)
        
        if high >= partial_target
            strategy.close("NY_PM_Long", qty=1, comment="NY PM Partial TP")
            strategy.exit("NY_PM_Long_Trail", "NY_PM_Long", stop=entry_price + 5, limit=take_profit, qty=1)
            ny_pm_partial_closed := true

// NY PM Short trade management  
if strategy.position_size < 0
    entry_price = strategy.position_avg_price
    stop_loss = ny_pm_high
    take_profit = entry_price - ny_pm_range_size
    partial_target = entry_price - (ny_pm_range_size * 0.5)
    
    if not ny_pm_partial_closed
        strategy.exit("NY_PM_Short_Exit", "NY_PM_Short", stop=stop_loss, limit=take_profit, qty=2)
        
        if low <= partial_target
            strategy.close("NY_PM_Short", qty=1, comment="NY PM Partial TP")
            strategy.exit("NY_PM_Short_Trail", "NY_PM_Short", stop=entry_price - 5, limit=take_profit, qty=1)
            ny_pm_partial_closed := true

// Reset partial closed flag when no position
if strategy.position_size == 0
    ny_pm_partial_closed := false
